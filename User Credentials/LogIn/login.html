<html>
  <head>
    <meta charset="utf-8" />

    <title>Login Page</title>
    <meta name="description" content="Figma htmlGenerator" />
    <link rel="stylesheet" href="styles.css" />

    <link
      href="https://fonts.googleapis.com/css?family=Inter&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
      integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://unicons.iconscout.com/release/v4.0.0/css/line.css"
    />
    <link rel="shortcut icon" type="image/png" href="images/ofc_Logo.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      body {
        background: #e5e5e5;
      }
    </style>
  </head>

  <body>
    <div class="e4_420">
      <div class="e12_2181"></div>
      <div class="e12_2182"></div>
      <div class="e12_2183"></div>
      <div class="e12_2184"></div>
      <div class="e14_2204"></div>
      <div class="e14_2213"></div>
      <span class="vW_Back">Welcome Back!</span>
      <span class="vN_See">Nice to see you again</span>
      <div class="name"></div>
      <form class="form-floating" id="floating">
        <div class="form-floating">
          <input
            class="form-control"
            type="text"
            id="floatingEmail"
            placeholder="Enter Email"
            aria-label="default input example"
          />
          <label for="floatingEmail">Email</label>
          <i class="fas fa-check-circle"></i>
          <i class="fas fa-exclamation-circle"></i>
          <small>Error message</small>
        </div>
        <div class="form-floating">
          <input
            type="password"
            class="form-control"
            id="floatingPassword"
            placeholder="Password"
          />
          <label for="floatingPassword">Password</label>
          <i class="fas fa-check-circle"></i>
          <i class="fas fa-exclamation-circle"></i>
          <i class="fa-regular fa-eye-slash showHidePw"></i>
          <small>Error message</small>
        </div>
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            value=""
            id="flexCheckChecked"
            checked
          />
          <label class="form-check-label" for="flexCheckChecked"
            >Keep me logged in</label>
        </div>
        <div class="Forgot_Password">
          <a href="#" class="text">Forgot Password?</a>
        </div>
        <div class="C_Acc1">
          <div class="C_Acc2"></div>
          <div class="C_Acc3">
            <button
              class="btn"
              style="background-color: transparent"
              id="sub_btn">
              Login
            </button>
          </div>
        </div>
      </form>
      <div class="Or1">
        <div class="name"></div>
        <div class="name"></div>
        <span class="Or2">or</span>
      </div>
      <div class="User_Logo">
        <i class="fa-regular fa-user"></i>
      </div>
      <div class="Pass_Logo">
        <img src="images/padlock2.png" style="width: 40px" />
      </div>
      <div class="SignUp_FB_Border">
        <div class="SignUp_FB"></div>
        <div class="SignUp_FB_Text">
          <button
            class="btn"
            style="background-color: transparent"
            id="facebooklogin"
            >Login with Facebook</button>
        </div>
        <div class="FB_Logo">
          <img src="images/facebook.png" style="width: 33px" />
        </div>
      </div>
      <div class="SignUp_Google_Border"></div>
      <div class="SignUp_Google"></div>
      <div class="SignUp_Google_Text">
        <button
          class="btn"
          style="background-color: transparent"
          id="googlelogin"
          >Login with Google</button>
      </div>
      <div class="Google_Logo">
        <img src="images/google.png" style="width: 33px" />
      </div>
      <span class="New_Acc">New here? </span>
      <div class="Create_Acc">
        <a
          href="/User Credentials/SignUp/Sign Up Page.html"
          class="link"
          style="background-color: transparent"
          type="submit"
          >Create an Account</a
        >
      </div>
    </div>

    <!-- partial -->
    <script src="./loginpage.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-analytics.js";
      import {
        getDatabase,
        set,
        ref,
        update,
        child,
        get,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        FacebookAuthProvider,
        signInWithPopup,
        GoogleAuthProvider,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBju8Bjp1PU8hpQaYhzu7CS81B9Zq6Tubk",
        authDomain: "erm-system-33be8.firebaseapp.com",
        databaseURL: "https://erm-system-33be8-default-rtdb.firebaseio.com",
        projectId: "erm-system-33be8",
        storageBucket: "erm-system-33be8.appspot.com",
        messagingSenderId: "1080942188838",
        appId: "1:1080942188838:web:2f1c49b62bc7d00aae09e7",
        measurementId: "G-RRB0LHPBLV"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const database = getDatabase(app);
      const provider = new GoogleAuthProvider(app);
      const provider2 = new FacebookAuthProvider(app);

      // Authentication
      floating.addEventListener("submit", (e) => {
        var email = document.getElementById("floatingEmail").value;
        var password = document.getElementById("floatingPassword").value;
        
        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
            // Signed in
            const user = userCredential.user;
            
            const dt = new Date(); 
            
            debugger
            update(ref(database, "users/" + user.uid), {
              email: email,
              last_login: dt,
            });
            localStorage.setItem("textvalue", email);
            localStorage.setItem("textname", user.displayName);
            alert("User logged in!");
            setTimeout(function(){
                    window.location.replace("/User Interface/User_Profile.html");
                }, 1000)
            
          })
          .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;

            alert(errorMessage);
          });
          
          function myFunction(){
          window.location.assign("/User Interface/User_Profile.html");
          }
      });

      onAuthStateChanged(auth, (user) => {
            if (user) {
                const dbRef = ref(database);
                const user1 = auth.currentUser;

                get(child(dbRef,"Reg_Users/"+ user1.uid)).then((snapshot)=>{
                  snapshot.forEach(childSnapshot=>{
                    console.log(snapshot.val().Username);
                    console.log(childSnapshot.child("Username").val());
                    localStorage.setItem("textname", snapshot.val().Username);
                  })
                });
            }
            });

      googlelogin.addEventListener('click', (e)=>{
      signInWithPopup(auth, provider)
      .then((result) => {
            // Google Access Token
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            // The signed-in user info.
            const user = result.user;

            alert(user.displayName);
        })
        .catch((error) => {
            // Handle Errors here.
            const errorCode = error.code;
            const errorMessage = error.message;
            // The email of the user's account used.
            const email = error.customData.email;
            // The AuthCredential type that was used.
            const credential = GoogleAuthProvider.credentialFromError(error);

            alert(errorMessage);
        });
    })

    facebooklogin.addEventListener('click', (e)=>{
        provider2.addScope('user_birthday');
        signInWithPopup(auth, provider2)
        .then((result) => {
            // The signed-in user info.
            const user = result.user;
            // Facebook Access Token
            const credential = FacebookAuthProvider.credentialFromResult(result);
            const accessToken = credential.accessToken;

            alert(user.displayName);
            // ...
            })
            .catch((error) => {
                // Handle Errors here.
                const errorCode = error.code;
                const errorMessage = error.message;
                // The email of the user's account used.
                const email = error.customData.email;
                // The AuthCredential type that was used.
                const credential = FacebookAuthProvider.credentialFromError(error);

                alert(errorMessage);
            });
        })
    </script>
  </body>
</html>
